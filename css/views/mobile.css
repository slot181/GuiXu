/* Phase 1 - views/mobile.css
   视图：移动端样式（以 .guixu-root-container.mobile-view / .mobile-view 为作用域）
   仅包含“移动端视图”相关规则；全屏相关仍放在 states/fullscreen.css
*/

/* 移动端：同样固定在右下角，略微再收紧 */
.guixu-root-container.mobile-view .version-badge {
  right: 8px;
  bottom: 6px;
  padding: 2px 5px;
  font-size: 9px;
}
.guixu-root-container.mobile-view .version-badge .vb-pill {
  padding: 1px 4px;
  font-size: 8.5px;
}

/* 移动端：隐藏顶部角落控制按钮（设置/视图切换/全屏），由“设置悬浮按钮”聚合 */
.guixu-root-container.mobile-view .settings-btn,
.guixu-root-container.mobile-view .view-toggle-btn,
.guixu-root-container.mobile-view .fullscreen-btn {
  display: none !important;
}

/* --- 新增：移动端视图样式 (由JS切换) --- */
/* 注意：.guixu-root-container 本身会被加上 mobile-view 类，因此需要用自身选择器而非祖先选择器 */
.guixu-root-container.mobile-view {
  width: 100% !important;
  height: auto !important; /* 关键修复：在嵌入式 iframe 中不要用 100%，避免父容器未定高导致内容高度为0 */
  aspect-ratio: unset;
  display: flex;
  flex-direction: column;
  /* 在移动端移除PC端的宽高比限制，并让容器占满视口 */
}

.mobile-view .game-container {
  /* 改为 Flex 以修复非全屏下主区过小与底部栏不出现问题 */
  display: flex;
  flex-direction: column;
  gap: 0;
  flex: 1 1 auto;   /* 让内容区填满根容器剩余空间 */
  min-height: 0;    /* 关键：允许子项正确计算高度，避免被挤压只显示数行 */
  height: auto;
}

/* 兜底修复：非全屏 + 移动端，确保容器至少占满视口高度，去除底部空白
   说明：在嵌入式环境下父级多为 auto/min-height，子项百分比高度无法吃到父级高度，
   导致 .game-container 未铺满根容器，底部栏上方出现“与最外边边框之间的空隙”。
   这里直接用动态视口单位为 .game-container 提供最小高度，以充满可视区。 */
.guixu-root-container.mobile-view:not(:fullscreen) .game-container {
  min-height: calc(100dvh - 0px);
  min-height: calc(100svh - 0px);
  min-height: calc(100vh - 0px);
}

/* 进一步兜底：使“根容器”在移动端非全屏时至少等于可视高度，避免根容器比视口矮导致底部出现留白 */
.guixu-root-container.mobile-view:not(:fullscreen) {
  min-height: 100dvh;
  min-height: 100svh;
  min-height: 100vh;
}

/* 让所有面板占据整行 */
.mobile-view .top-status,
.mobile-view .character-panel,
.mobile-view .main-content,
.mobile-view .interaction-panel,
.mobile-view .bottom-status {
  grid-column: 1 / -1;
}

.mobile-view .character-panel {
  grid-row: 3;
  /* 移动到正文下方 */
  border-right: none;
  border-bottom: 1px solid #c9aa71;
  max-height: 250px;
  /* 给一个最大高度，内容可滚动 */
}

.mobile-view .main-content {
  grid-row: 2;
  /* 移动到顶部下方 */
}

.mobile-view .interaction-panel {
  grid-row: 4;
  border-left: none;
  border-top: 1px solid #c9aa71;
  flex-direction: row;
  /* 按钮横向排列 */
  flex-wrap: wrap;
  /* 允许换行 */
  justify-content: center;
  gap: 8px;
  padding: 8px;
}

.mobile-view .interaction-btn {
  flex-grow: 1;
  /* 让按钮填充空间 */
  min-width: 120px;
  /* 最小宽度 */
}

.mobile-view .world-line-section {
  width: 100%;
  display: flex;
  justify-content: space-around;
}

.mobile-view .bottom-status {
  display: flex;               /* 覆盖桌面的 grid，移动端改为垂直堆叠 */
  flex-direction: column;
  align-items: stretch;
  height: auto;
  gap: 10px;
  padding: 10px 14px;  /* 增加左右内边距，避免子项贴边 */
  box-sizing: border-box;
}

.guixu-root-container.mobile-view .quick-send-container {
  display: flex !important; /* 覆盖 JS 动态注入的 grid，移动端改为纵向布局 */
  flex-direction: column;
  width: 100%;
  gap: 8px;
}
/* 移动端：刷新 + 重掷 两键等宽、左右分布（仅当 .qs-left 打上 .qs-left--two-btn 时生效） */
.guixu-root-container.mobile-view .quick-send-container .qs-left.qs-left--two-btn {
  display: grid;
  grid-template-columns: 1fr 1fr; /* 两列等分，刚好铺满一行 */
  gap: 10px; /* 与外层间距保持一致 */
}
.guixu-root-container.mobile-view #btn-first-run-refresh,
.guixu-root-container.mobile-view #btn-reroll-last {
  flex: 1 1 auto;
  width: 100%;          /* 在两列网格下占满各自列 */
  height: 34px;
  min-width: 0;
  box-sizing: border-box;
}

/* 让输入区在移动端占满宽度 */
.mobile-view .quick-send-input {
  width: 100%;
}

/* 发送按钮与输入同宽，左右铺满 */
.guixu-root-container.mobile-view .quick-send-container .qs-right #btn-quick-send {
  width: 100%;
  height: 36px;
  min-width: 0;
  box-sizing: border-box;
}

/* 三段式子区块在移动端拉伸到整行宽度 */
.guixu-root-container.mobile-view .quick-send-container .qs-left,
.guixu-root-container.mobile-view .quick-send-container .qs-center,
.guixu-root-container.mobile-view .quick-send-container .qs-right {
  width: 100%;
}

/* 状态一览按钮单独一行，且与下方内容同一最大宽度区域居中 */
.guixu-root-container.mobile-view #btn-status-pop {
  align-self: center;
  margin: 0 auto 2px auto; /* 水平居中，稍微与下一行留缝 */
  max-width: 680px;
  width: auto; /* 保持芯片宽度，不再拉满整行 */
}

/* 非全屏的移动端：为底部栏内容设置统一最大宽度，避免贴边并与“状态一览”对齐 */
.guixu-root-container.mobile-view:not(.mobile-landscape-fullscreen) .bottom-status .quick-send-container,
.guixu-root-container.mobile-view:not(.mobile-landscape-fullscreen) .bottom-status .qs-left,
.guixu-root-container.mobile-view:not(.mobile-landscape-fullscreen) .bottom-status .qs-center,
.guixu-root-container.mobile-view:not(.mobile-landscape-fullscreen) .bottom-status .qs-right {
  max-width: 680px;
  width: 100%;
  margin: 0 auto;
}

/* 移动端快速指令弹窗宽度适配 */
.mobile-view #quick-command-popup {
  width: 90%;
  left: 5%;
  right: 5%;
  bottom: 110px;
  /* 调整位置 */
}

/* 调整字体大小（移动端更紧凑） */
.mobile-view .status-value {
  font-size: 12px;
}

.mobile-view .status-label {
  font-size: 10px;
}

.mobile-view .section-title {
  font-size: 12px;
}

.mobile-view .attribute-item {
  font-size: 11px;
}

.mobile-view .game-text-container {
  /* 改为跟随设置中心的故事文本字号，修复移动端字号不生效 */
  font-size: var(--guixu-story-font-size, 13px);
}

.mobile-view .interaction-btn {
  font-size: 11px;
}

/* 移动端：Flex布局下的区块顺序与尺寸 */
.mobile-view .top-status { order: 1; flex: 0 0 auto; }
/* 固定正文高度交由 JS(_reflowMobileLayout) 计算，CSS 侧不再拉伸主区 */
.mobile-view .main-content { order: 2; flex: 0 0 auto; min-height: 320px; overflow-y: auto; }
.mobile-view .character-panel { order: 3; }
.mobile-view .interaction-panel { order: 4; }
.mobile-view .bottom-status { order: 5; flex: 0 0 auto; }

/* 移动端：侧栏以浮层形式显示，默认隐藏，通过根容器的开关类控制显隐 */
.mobile-view .character-panel,
.mobile-view .interaction-panel {
  display: none;
}

.mobile-view.show-character-panel .character-panel,
.mobile-view.show-interaction-panel .interaction-panel {
  display: block !important;
  position: fixed !important;
  /* 居中显示（类似状态一览的模态居中风格） */
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: min(700px, 92vw);
  max-width: 92vw;
  height: min(520px, 80vh);
  max-height: 80vh;
  z-index: 10050;           /* 提升层级，确保浮层在所有遮罩之上 */
  pointer-events: auto;     /* 明确允许接收点击 */
  overflow-y: auto;
  background: rgba(26, 26, 46, 0.95);
  border: 1px solid #c9aa71;
  border-radius: 10px;
  padding: 14px;
  box-shadow: 0 12px 28px rgba(0,0,0,0.55);
  backdrop-filter: blur(1px);
}

/* 移动端浮窗（功能面板）布局增强：采用网格，避免按钮挤成一坨 */
.mobile-view.show-interaction-panel .interaction-panel {
  display: grid !important;
  grid-template-columns: repeat(2, minmax(100px, 1fr)); /* 更小的列最小宽，减轻拥挤 */
  grid-auto-rows: minmax(40px, auto);                  /* 每行最小高度，避免挤压变形 */
  gap: 10px !important;
  padding: 12px !important;
}
/* 功能按钮：两列排布，统一高度 */
.mobile-view.show-interaction-panel .interaction-panel .interaction-btn {
  height: 40px;
  min-width: 0;
  padding: 0 10px;
  white-space: nowrap;
  box-sizing: border-box;
}
/* 功能区内的模块区块（世界书控制、世界线回顾等）占满整行，避免被按钮挤压 */
.mobile-view.show-interaction-panel .interaction-panel .panel-section {
  grid-column: 1 / -1;
}
/* 世界线回顾区块：占整行并重置为块级，避免父级 flex 规则干扰导致挤压/变形 */
.mobile-view.show-interaction-panel .interaction-panel .world-line-section {
  display: block !important;     /* 覆盖 .mobile-view .world-line-section 的 flex 设置 */
  width: 100%;
  margin-top: 12px;
  grid-column: 1 / -1;           /* 在两列栅格中占满整行，确保居中对称 */
}
/* 世界线回顾区域：内部两键等分排布，间距合理 */
.mobile-view.show-interaction-panel .interaction-panel .world-line-section > div:not(.world-line-title) {
  display: grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 10px !important;
  width: 100% !important;
  justify-content: stretch !important; /* 覆盖原内联的居中，避免右侧留白 */
  align-items: stretch !important;
}
.mobile-view.show-interaction-panel .interaction-panel .world-line-section .worldline-btn {
  height: 40px;
  min-width: 0;
  width: 100%;
  padding: 0 12px;
  font-size: 13px;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;              /* 防止文本溢出按钮 */
  text-overflow: ellipsis;       /* 宽度不足时省略号 */
  box-sizing: border-box;
}

/* 移除半透明遮罩，避免点击浮窗时整屏变暗 */
.guixu-root-container.mobile-view.show-character-panel::after,
.guixu-root-container.mobile-view.show-interaction-panel::after {
  content: none;
}

/* 浮层显示时，主区域可继续滚动；如需弱化背景可半透明遮罩（不拦截点击） */
.mobile-view.show-character-panel .main-content,
.mobile-view.show-interaction-panel .main-content {
  filter: none;
}

/* 移动端视口容器在移动视图下允许滚动，修复非全屏下无法下拉的问题 */
.guixu-viewport.mobile-view {
  position: relative;
  width: 100%;
  height: auto;
  margin: 0 auto;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* --- 移动端-设置中心 浮窗尺寸与布局修复（不影响桌面） --- */
.guixu-root-container.mobile-view #settings-modal .modal-content {
  width: 96vw;
  max-width: 96vw;
  height: auto;
  max-height: 90vh;
  overflow-x: hidden;
}
.guixu-root-container.mobile-view #settings-modal .modal-body {
  overflow-y: auto;
}
.guixu-root-container.mobile-view #settings-modal .modal-header {
  flex-wrap: wrap;
  gap: 8px;
}
.guixu-root-container.mobile-view #settings-modal .attributes-list .attribute-item {
  flex-wrap: wrap !important;
  gap: 6px !important;
}

/* 分辨率模块：预设与自定义在移动端分行排布，输入框等分（从 guixu.css 迁移） */
.guixu-root-container.mobile-view #settings-modal .attributes-list .attribute-item .attribute-name {
  white-space: nowrap;
}
.guixu-root-container.mobile-view #settings-modal #pref-bg-select {
  flex: 1 1 100% !important;
  min-width: 0 !important;
  max-width: 100% !important;
}
.guixu-root-container.mobile-view #settings-modal #pref-bg-upload,
.guixu-root-container.mobile-view #settings-modal #pref-bg-delete,
.guixu-root-container.mobile-view #settings-modal #pref-bg-clear {
  flex: 1 1 calc(33% - 6px) !important;
  min-width: 0 !important;
}

/* 移动端-设置中心：按钮尺寸与页脚布局优化，防止超出浮窗 */
.guixu-root-container.mobile-view #settings-modal .attributes-list .interaction-btn,
.guixu-root-container.mobile-view #settings-modal .attributes-list .danger-btn {
  min-width: 0 !important;
  height: 34px !important;
  padding: 0 10px !important;
  flex: 1 1 auto !important;
  box-sizing: border-box !important;
}
/* 设置中心页脚：上方“恢复默认”独占一行，下面“应用/保存并关闭”双列并排 */
.guixu-root-container.mobile-view #settings-modal .command-center-footer {
  flex-wrap: wrap !important;
  gap: 8px !important;
}
.guixu-root-container.mobile-view #settings-modal #pref-reset-defaults {
  flex: 1 1 100% !important;
  height: 36px !important;
}
.guixu-root-container.mobile-view #settings-modal .command-center-footer > div {
  width: 100% !important;
  display: grid !important;
  grid-template-columns: 1fr 1fr !important;
  gap: 8px !important;
}
.guixu-root-container.mobile-view #settings-modal .command-center-footer > div > button {
  width: 100% !important;
  height: 36px !important;
  min-width: 0 !important;
  padding: 0 10px !important;
  box-sizing: border-box !important;
}

/* 更新提醒浮窗（移动端适配） */
.guixu-root-container.mobile-view #update-modal .modal-content {
  width: 96vw;
  max-width: 96vw;
  height: auto;
  max-height: 90vh;
  overflow-x: hidden;
}
.guixu-root-container.mobile-view #update-modal .modal-body {
  overflow-y: auto;
}
.guixu-root-container.mobile-view #update-modal .confirm-modal-buttons {
  flex-wrap: wrap;
  gap: 8px;
  align-items: stretch;
}
.guixu-root-container.mobile-view #update-modal .confirm-modal-buttons > .interaction-btn,
.guixu-root-container.mobile-view #update-modal .confirm-modal-buttons > .primary-btn,
.guixu-root-container.mobile-view #update-modal #update-go-btn,
.guixu-root-container.mobile-view #update-modal #update-later-btn {
  min-width: 0;
  height: 34px;
  padding: 0 10px;
  flex: 1 1 auto;
  box-sizing: border-box;
}
.guixu-root-container.mobile-view #update-modal .dont-remind {
  width: 100%;
  margin-right: 0 !important;
  order: -1;
  margin-bottom: 6px;
}

/* 移动端-存档管理 浮窗与每条存档布局优化（不影响桌面） */
.guixu-root-container.mobile-view #save-load-modal .modal-content {
  width: 96vw;
  max-width: 96vw;
  height: auto;
  max-height: 90vh;
  overflow-x: hidden;
}
.guixu-root-container.mobile-view #save-load-modal .modal-body {
  overflow-y: auto;
}
.guixu-root-container.mobile-view #save-load-modal .modal-header {
  flex-wrap: wrap;
  gap: 8px;
}
.guixu-root-container.mobile-view #save-slots-container .save-slot {
  flex-direction: column;
  align-items: stretch;
  gap: 10px;
}
.guixu-root-container.mobile-view #save-slots-container .save-slot-info {
  width: 100%;
}
.guixu-root-container.mobile-view #save-slots-container .save-slot-actions {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px;
  width: 100%;
  justify-content: stretch;
}
.guixu-root-container.mobile-view #save-slots-container .save-slot-actions > button {
  height: 36px;
  padding: 0 10px;
  min-width: 0;
  box-sizing: border-box;
}

/* 移动端-自动存档列表：与手动存档一致的纵向布局与按钮网格 */
.guixu-root-container.mobile-view #auto-save-slot-container > .save-slot,
.guixu-root-container.mobile-view #auto-save-slot-container > .auto-save-slot {
  display: flex !important;
  flex-direction: column !important;
  align-items: stretch !important;
  gap: 10px !important;
}
.guixu-root-container.mobile-view #auto-save-slot-container .save-slot-info,
.guixu-root-container.mobile-view #auto-save-slot-container .slot-info {
  width: 100% !important;
}
.guixu-root-container.mobile-view #auto-save-slot-container .save-slot-actions,
.guixu-root-container.mobile-view #auto-save-slot-container .slot-actions {
  display: grid !important;
  grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
  gap: 8px !important;
  width: 100% !important;
  justify-content: stretch !important;
}
.guixu-root-container.mobile-view #auto-save-slot-container button {
  height: 36px !important;
  padding: 0 10px !important;
  min-width: 0 !important;
  box-sizing: border-box !important;
}

/* --- 移动端：历史面板头部换行与搜索栏自适应，防止“清除”溢出 --- */
.guixu-root-container.mobile-view #history-modal .modal-header {
  flex-wrap: wrap !important;
  gap: 8px !important;
}
.guixu-root-container.mobile-view #history-modal #history-modal-actions {
  order: 2 !important;
  flex: 1 1 100% !important;
  display: flex !important;
  gap: 8px !important;
  flex-wrap: wrap !important; /* 允许换行，避免溢出 */
  margin-left: 0 !important;  /* 覆盖内联 margin-left:auto，防止动作区被推到面板外 */
}
.guixu-root-container.mobile-view #history-modal .history-search {
  flex: 1 1 100% !important;    /* 独占一行 */
  min-width: 0 !important;
  margin-left: 0 !important;    /* 移除左侧间距，防止被挤出 */
}
.guixu-root-container.mobile-view #history-modal .history-search input#history-search-input {
  flex: 1 1 auto !important;
  min-width: 0 !important;
  width: auto !important;
}
.guixu-root-container.mobile-view #history-modal .history-search #history-search-clear {
  flex: 0 0 auto !important;
  min-width: 72px !important;
}

/* --- 时间线标签在小屏换行且不挤压布局 --- */
.guixu-root-container.mobile-view .timeline-header {
  flex-direction: column !important;
  align-items: flex-start !important;
  gap: 6px !important;
}
.guixu-root-container.mobile-view .timeline-tags {
  max-width: 100% !important;
  width: 100% !important;
  justify-content: flex-start !important;
}

/* 移动端视口容器在移动视图下允许滚动，修复非全屏下无法下拉的问题（补充） */
.guixu-viewport.mobile-view {
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

/* 移动端 FAB 尺寸下调（统一在移动端隐藏顶部角落控制按钮由JS聚合） */
.guixu-root-container.mobile-view .mobile-fab {
  width: 44px !important;
  height: 44px !important;
  font-size: 12px !important;
  border-radius: 50% !important;
}

/* 移动端紧凑输入高度（从 guixu.css 迁移，保持变量名与影响范围不变） */
@media (max-width: 520px) {
  .guixu-root-container {
    --gx-input-height: 30px;
  }
}
